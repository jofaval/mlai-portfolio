<?php

require_once 'require.php';

/**
 * The CLI given commands
 */
define('ARGS', $argv);

/**
 * The default chmod permissions
 * 
 * @var int
 */
define('PERMISSIONS', 0755);

/**
 * Create a project
 * 
 * @param string $name
 * 
 * @return string
 */
function create_project(string $name)
{
    # code...
}

/**
 * Minimize a script
 * 
 * @param string $script
 * 
 * @return string
 */
function minimizeScript(string $script)
{
    # code...
}

/**
 * Minimize a style
 * 
 * @param string $style
 * 
 * @return string
 */
function minimizeStyle(string $style)
{
    # code...
}

function get_arg(int $index, $default = null)
{
    return isset(ARGS[$index]) ? ARGS[$index] : $default;
}

function get_action()
{
    // Take into account the CLI call in the args
    return get_arg(1);
}

$action = get_action();

/**
 * Get the real content of a file, already compiled
 * 
 * @param string $file The file path
 * 
 * @return string
 */
function get_content(string $file)
{
    // DEPRECATED
    // $content = file_get_contents($file);

    if (!file_exists($file) || !is_file($file)) {
        return 'Not found';
    }

    ob_start();
    require $file;
    $content = ob_get_clean();

    return $content;
}

// TODO: parse into actions.php inside "cli" folder
/**
 * Rebuilds a single file
 * 
 * @param string $file The file to rebuild. If it's not given, it will try to get it from the args
 * @param bool $absolute Will it be an absolute path? By default it will
 * 
 * @return bool
 */
function rebuild(string $file = null, bool $absolute = true)
{
    // If the file was not given, it get it from the args
    if (is_null($file)) $file = get_arg(2);
    // If it's an empty name, returns false
    if (empty($file)) return false;

    // Paths starts at public/ 
    $new_file_path = str_replace(PUBLIC_DIR, BUILD_DIR, $file);
    $content = get_content($file);
    
    $new_dir = dirname($new_file_path);
    // Create the new folder architecture if doesn't exist yet
    if (!file_exists($new_dir)) mkdir($new_dir, PERMISSIONS, true);
    
    // If it's a php file, replace it to html
    $new_file_path = str_replace('.php', '.html', $new_file_path);
    // Input the hew content
    $success = file_put_contents($new_file_path, $content) !== false;

    return $success;
}

/**
 * All the files to ignore
 * 
 * @var string[]
 */
define('IGNORE_FILES', [
    '.css',
    '.js',
    path_join('public', 'index.html'),
]);

/**
 * Retruns all the files to compile
 * 
 * @param string $root The root from which to get all files
 * @param string $base_root The default root, PUBLIC_DIR by default
 * 
 * @return string[]
 */
function get_all_files(string $root = null, string $base_root = PUBLIC_DIR)
{
    // If no root is given, the $base_root will be used
    if (is_null($root)) $root = $base_root;

    $files = array_diff( scandir($root), [ '.', '..' ] );

    // Add absolute path
    $files = array_map(function (string $file) use ($root)
    {
        return path_join($root, $file);
    }, $files);

    // Implement recursiveness
    foreach ($files as $file_index => $file) {
        if (is_dir($file)) { // Recurse if necessary
            $subfiles = get_all_files($file);
            // Delete the folder
            unset($files[$file_index]);

            $files = array_merge($files, $subfiles);
        }
    }

    return $files;
}

/**
 * Removes all the content from a dir
 * 
 * @param string $dir The target dir
 * 
 * @return void
 */
function empty_dir(string $dir)
{
    foreach(glob($dir . '/*') as $file) {
        if (is_file($file)) unlink($file);
        else if (is_dir($file)) {
            empty_dir($file);
            rmdir($file);
        }
    }
}

/**
 * Builds all the files into minimized .html
 * 
 * @return bool
 */
function build()
{
    // TODO: implementar dd(); y logs ya de paso?
    $files = get_all_files();

    // TODO: create decorator for a real get_all_files?
    $files = array_filter($files, function(string $file)
    {
        foreach (IGNORE_FILES as $ignore) {
            $ignore = str_replace('*', '', $ignore);

            if (str_ends_with($file, $ignore) || str_contains($file, $ignore)) return false;
        }

        return true;
    });

    // Check if file exists, if it does, empty it, if it doesn't create it
    if (!file_exists(BUILD_DIR)) mkdir(BUILD_DIR);
    else empty_dir(BUILD_DIR);

    $success = true;
    $total_files = count($files);
    $file_index = 0;
    foreach ($files as $file) {
        $success &= rebuild($file);
        // As soon as it fails, stop it
        if (!$success) return;

        $file_index++;

        // Calculate progress
        $human_file_index = $file_index;
        $progress = ($human_file_index / $total_files) * 100;
        $progress = round($progress);
        $filename = str_replace(PUBLIC_DIR, '', $file);
        $filename = str_replace('\\', '/', $filename);
        echo "\"$filename\" has been compiled, A total of $progress% has been compiled, ($human_file_index/$total_files).\n";
    }

    return $success;
}

if (function_exists($action)) $action();